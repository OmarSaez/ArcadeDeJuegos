<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Boom </title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="dictionary.js"></script>
    <style>
        :root {
            --bg-body: #2c3e50;
            --primary: #c0392b;
            /* Red for bomb */
            --accent: #f1c40f;
            /* Yellow for explosion/warning */
            --text-light: #ecf0f1;
            --panel: #34495e;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg-body);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-body);
            z-index: 10;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 3rem;
            color: var(--accent);
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 10px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 0 #96281b;
            transition: 0.1s;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        input {
            padding: 10px;
            font-size: 1.2rem;
            text-align: center;
            border-radius: 5px;
            border: 2px solid #555;
            margin: 10px;
            width: 250px;
        }

        /* BOMB DESIGN */
        #bomb-container {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 20px;
            transition: transform 0.1s;
        }

        .bomb-body {
            width: 100%;
            height: 100%;
            background: #222;
            border-radius: 50%;
            box-shadow: inset -10px -10px 20px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .fuse {
            width: 10px;
            height: 40px;
            background: #8e44ad;
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: -1;
        }

        .spark {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            animation: flicker 0.1s infinite;
            display: none;
        }

        @keyframes flicker {
            0% {
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }

            100% {
                opacity: 0.5;
                transform: translateX(-50%) scale(1.2);
            }
        }

        /* PULSE ANIMATION */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .ticking {
            animation: pulse 1s infinite;
        }

        .fast-ticking {
            animation: pulse 0.3s infinite;
        }

        @keyframes shake-pulse {
            0% {
                transform: scale(1) rotate(0deg);
            }

            25% {
                transform: scale(1.1) rotate(-5deg);
            }

            50% {
                transform: scale(1.2) rotate(5deg);
            }

            75% {
                transform: scale(1.1) rotate(-5deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        .critical-ticking {
            animation: shake-pulse 0.2s infinite;
            background: #c0392b !important;
        }

        @keyframes shake-input {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .input-error {
            animation: shake-input 0.3s;
            border-color: #c0392b !important;
            color: #c0392b;
        }

        @keyframes explode-anim {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(3) rotate(20deg);
                opacity: 0.8;
            }

            100% {
                transform: scale(10) rotate(-20deg);
                opacity: 0;
            }
        }

        .exploding {
            animation: explode-anim 0.6s forwards ease-out;
        }

        @keyframes screen-shake-hard {
            0% {
                transform: translate(0, 0) rotate(0);
            }

            25% {
                transform: translate(-20px, 20px) rotate(-5deg);
            }

            50% {
                transform: translate(20px, -20px) rotate(5deg);
            }

            75% {
                transform: translate(-20px, -10px) rotate(-5deg);
            }

            100% {
                transform: translate(0, 0) rotate(0);
            }
        }

        .shake-screen {
            animation: screen-shake-hard 0.5s ease-in-out;
        }

        /* SYLLABLE DISPLAY */
        #syllable-display {
            font-size: 4rem;
            font-weight: bold;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid var(--accent);
        }

        /* PLAYER LIST */
        #player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 800px;
            padding: 10px;
        }

        .player-card {
            background: var(--panel);
            padding: 10px;
            border-radius: 5px;
            min-width: 100px;
            text-align: center;
            border: 2px solid transparent;
        }

        .player-card.active {
            border-color: var(--accent);
            background: #444;
        }

        .player-card.dead {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .lives {
            color: var(--primary);
            font-size: 1.2rem;
        }

        /* Main centering for Game Screen */
        #screen-game {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            #screen-game {
                justify-content: flex-start;
                align-items: center;
                padding: 20px 0;
                height: auto;
                min-height: 100vh;
            }

            h1 {
                font-size: 1.5rem;
                margin: 0 0 10px 0;
            }

            #syllable-display {
                font-size: 3rem;
                padding: 10px 30px;
                margin: 10px 0 30px 0;
            }

            #bomb-container {
                width: 140px;
                height: 140px;
                margin: 0 0 20px 0;
                flex-shrink: 0;
            }

            #turn-msg {
                margin: 10px 0;
                font-size: 1.2rem;
            }

            /* Stack Input and Button nicely */
            #input-area {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                width: 100%;
                gap: 15px;
                margin-bottom: 20px;
            }

            #word-input {
                width: 80%;
                text-align: center;
                font-size: 1.2rem;
                padding: 12px;
                border-radius: 8px;
            }

            #input-area .btn {
                width: 80%;
                padding: 12px;
                font-size: 1.2rem;
            }

            #player-list {
                width: 100%;
                justify-content: center;
                margin-bottom: 20px;
            }

            /* Mobile Used Words Panel */
            #used-words-panel {
                display: block !important;
                position: static !important;
                transform: none !important;
                width: 90% !important;
                margin: 10px auto !important;
                background: rgba(0, 0, 0, 0.3);
                border: 1px solid #555;
                padding: 10px;
                border-radius: 8px;
                text-align: center;
                max-height: 200px;
                overflow-y: auto;
                order: 999;
            }

            #used-words-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }

            .used-word-item {
                border-bottom: none;
                background: rgba(255, 255, 255, 0.15);
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 0.9rem;
                margin: 0;
            }
        }

        #used-words-panel {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 180px;
            max-height: 60vh;
            background: rgba(0, 0, 0, 0.3);
            border-left: 2px solid var(--accent);
            padding: 10px;
            overflow-y: auto;
            border-radius: 10px 0 0 10px;
            text-align: right;
        }

        #used-words-panel h3 {
            margin: 0 0 10px 0;
            color: #aaa;
            font-size: 1rem;
        }

        .used-word-item {
            color: #fff;
            margin: 5px 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            border-bottom: 1px solid #444;
            padding-bottom: 2px;
        }
    </style>
</head>

<body>

    <!-- MENU -->
    <div id="screen-menu" class="screen">
        <h1> TIC-TAC-BOOM</h1>
        <input type="text" id="my-name" placeholder="Tu Nombre">
        <div>
            <button class="btn" onclick="tryCreateRoom()">CREAR SALA</button>
            <button class="btn" style="background:#555;" onclick="showJoin()">UNIRSE</button>
        </div>
        <button class="btn" style="background:#555; margin-top:20px;"
            onclick="window.location.href='https://omarsaez.github.io/ArcadeDeJuegos/'">VOLVER AL ARCADE</button>
    </div>

    <!-- JOIN -->
    <div id="screen-join" class="screen hidden">
        <h2>Ingresa C贸digo</h2>
        <input type="text" id="join-code" placeholder="CDIGO">
        <button class="btn" onclick="tryJoinRoom()">ENTRAR</button>
        <button class="btn" style="background:#555;" onclick="showMenu()">ATRS</button>
    </div>

    <!-- LOBBY -->
    <div id="screen-lobby" class="screen hidden">
        <h2>SALA: <span id="lobby-code" style="color:var(--accent)">----</span></h2>
        <div id="lobby-list" style="margin: 20px;"></div>
        <div id="host-controls" class="hidden">
            <button class="btn" onclick="startGame()">COMENZAR PARTIDA</button>
        </div>
        <p id="wait-msg">Esperando al l铆der...</p>
    </div>

    <!-- GAME -->
    <div id="screen-game" class="screen hidden">
        <div id="syllable-display">---</div>

        <div id="bomb-container">
            <div class="fuse"></div>
            <div class="spark" id="spark"></div>
            <div class="bomb-body">
                <span style="font-size:3rem;"></span>
            </div>
        </div>

        <h2 id="turn-msg">Turno de: NADIE</h2>

        <div id="input-area" class="hidden">
            <input type="text" id="word-input" placeholder="Escribe la palabra...">
            <button class="btn" onclick="submitWord()">ENVIAR</button>
        </div>

        <div id="player-list"></div>

        <div id="used-words-panel">
            <h3>USADAS</h3>
            <div id="used-words-list"></div>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="screen-results" class="screen hidden" style="background:rgba(0,0,0,0.95); z-index: 20;">
        <canvas id="confetti-canvas"
            style="position:absolute; top:0; left:0; pointer-events:none; width:100%; height:100%;"></canvas>
        <h1 style="color:var(--accent); font-size: 3rem; margin-bottom: 10px;"> GANADOR </h1>
        <h2 id="winner-text" style="color:white; font-size: 2.5rem; margin-top:0;">---</h2>

        <h3 id="game-duration" style="color:#aaa;">Duraci贸n: 00:00</h3>

        <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; width:300px; max-width:90%;">
            <h4 style="margin:5px 0;">Historial de Palabras</h4>
            <div id="final-words-list"
                style="height: 150px; overflow-y: auto; text-transform: uppercase; font-size: 0.9rem; color:#ddd; text-align:center; border-top:1px solid #555; padding-top:5px;">
                <!-- Words go here -->
            </div>
        </div>

        <div style="margin-top:20px; display:flex; gap:10px; justify-content:center; z-index: 30;">
            <button class="btn" onclick="location.reload()">VOLVER AL MENU</button>
            <button class="btn" style="background:#555;"
                onclick="window.location.href='https://omarsaez.github.io/ArcadeDeJuegos/'">VOLVER AL
                ARCADE</button>
        </div>
    </div>

    <script>
        // --- LOGICA DEL JUEGO ---
        let myId = null, myName = "Player";
        let isHost = false;
        let peer, hostConn, clientConns = {};
        let players = []; // {id, name, lives: 3, ...}

        let DICTIONARY_SET = new Set();
        // Load Dictionary from JS file (works offline/local)
        if (window.RAW_DICT) {
            const words = window.RAW_DICT.split(' ');
            for (let i = 0; i < words.length; i++) {
                if (words[i]) DICTIONARY_SET.add(words[i]);
            }
            console.log("Diccionario Cargado: " + DICTIONARY_SET.size + " palabras");
            window.RAW_DICT = null; // Free Memory
        } else {
            console.warn("DICCIONARIO NO ENCONTRADO - Modo Libre");
        }

        // Estado del Juego
        let gameState = {
            syllable: '',
            currentPlayerId: null,
            bombSpeed: 1000,
            timer: 0,
            usedWords: new Set(),
            sessionWords: [],
            gameStartTime: 0
        };

        // Diccionario (Simplificado)
        // Diccionario (Simplificado - Nivel F谩cil/Medio)
        const SYLLABLES = [
            // S铆labas Directas (F谩cil)
            'BA', 'CA', 'DA', 'FA', 'GA', 'HA', 'JA', 'LA', 'MA', 'NA', 'PA', 'RA', 'SA', 'TA', 'VA', 'ZA',
            'BE', 'CE', 'DE', 'FE', 'GE', 'HE', 'JE', 'LE', 'ME', 'NE', 'PE', 'RE', 'SE', 'TE', 'VE',
            'BI', 'CI', 'DI', 'FI', 'GI', 'HI', 'JI', 'LI', 'MI', 'NI', 'PI', 'RI', 'SI', 'TI', 'VI',
            'BO', 'CO', 'DO', 'FO', 'GO', 'HO', 'JO', 'LO', 'MO', 'NO', 'PO', 'RO', 'SO', 'TO', 'VO',
            'BU', 'CU', 'DU', 'FU', 'GU', 'HU', 'JU', 'LU', 'MU', 'NU', 'PU', 'RU', 'SU', 'TU', 'VU',

            // Inversas Comunes (F谩cil)
            'AL', 'AN', 'AR', 'AS', 'EL', 'EN', 'ER', 'ES', 'IN', 'IS', 'ON', 'OR', 'OS', 'UN',

            // 3 Letras Comunes (Medio - Solo las muy frecuentes)
            'CON', 'COM', 'ENT', 'EST', 'PER', 'PRO', 'PAR', 'VER', 'TER', 'DIS', 'TRA', 'POR', 'QUE', 'DEL', 'LAS', 'SOL', 'PAN', 'MAR'
        ];

        // --- NAVIGATION ---
        function show(id) { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function showMenu() { show('screen-menu'); }
        function showJoin() { show('screen-join'); }

        // --- PEERJS SETUP (Reuse Logic) ---
        function tryCreateRoom() {
            myName = document.getElementById('my-name').value || "Host";
            peer = new Peer(Math.random().toString(36).substr(2, 4).toUpperCase());
            peer.on('open', id => {
                myId = id; isHost = true;
                players = [{ id, name: myName, lives: 2 }]; // 2 Vidas
                setupHost();
                updateLobby();
                show('screen-lobby');
                document.getElementById('lobby-code').innerText = id;
            });
        }

        function setupHost() {
            document.getElementById('host-controls').classList.remove('hidden');
            document.getElementById('wait-msg').classList.add('hidden');
            peer.on('connection', conn => {
                clientConns[conn.peer] = conn;
                conn.on('open', () => conn.send({ type: 'UPDATE_PLAYERS', list: players }));
                conn.on('data', data => handleHostData(conn.peer, data));
            });
        }

        function tryJoinRoom() {
            myName = document.getElementById('my-name').value.trim() || "Guest";
            const code = document.getElementById('join-code').value.trim().toUpperCase();

            if (!code) return alert("Por favor ingresa un c贸digo.");

            peer = new Peer();

            peer.on('error', err => {
                if (err.type === 'peer-unavailable') {
                    alert("锔 Sala no encontrada. El c贸digo " + code + " no existe o el anfitri贸n no est谩 conectado.");
                    show('screen-join');
                    if (hostConn) hostConn.close();
                } else {
                    console.error("Peer Error:", err);
                }
            });

            peer.on('open', id => {
                myId = id;
                hostConn = peer.connect(code);

                hostConn.on('open', () => {
                    hostConn.send({ type: 'LOGIN', name: myName });
                    show('screen-lobby');
                    document.getElementById('lobby-code').innerText = code;

                    hostConn.on('data', handleClientData);
                    hostConn.on('close', () => {
                        alert("Desconectado de la sala.");
                        location.reload();
                    });
                });

                // Connection Timeout
                setTimeout(() => {
                    if (!hostConn || !hostConn.open) {
                        if (document.getElementById('screen-lobby').classList.contains('hidden')) {
                            console.warn("Connection Timed Out");
                        }
                    }
                }, 5000);
            });
        }

        // --- HOST LOGIC ---
        let bombInterval;
        let explosionTime = 0;
        let sentFast = false, sentCritical = false;

        function handleHostData(id, data) {
            if (data.type === 'LOGIN') {
                players.push({ id, name: data.name, lives: 2 });
                broadcast({ type: 'UPDATE_PLAYERS', list: players });
            }
            else if (data.type === 'SUBMIT_WORD') {
                if (id === gameState.currentPlayerId) {
                    const w = data.word.toUpperCase().trim();
                    // Verify Word & Duplicates
                    if (!verifyWord(w, gameState.syllable) || gameState.usedWords.has(w)) {
                        broadcast({ type: 'REJECT_WORD', playerId: id });
                        return;
                    }

                    gameState.usedWords.add(w);
                    gameState.sessionWords.push(w);
                    broadcast({ type: 'WORD_ACCEPTED', word: w });
                    passBomb();
                }
            }
        }

        function startGame() {
            if (players.length < 2) return alert("Minimo 2 jugadores");
            gameState.currentPlayerId = players[0].id;
            gameState.usedWords.clear();
            gameState.sessionWords = [];
            gameState.gameStartTime = Date.now();
            nextRound();
        }

        function nextRound() {
            gameState.usedWords.clear();
            // New Syllable
            gameState.syllable = SYLLABLES[Math.floor(Math.random() * SYLLABLES.length)];

            // Random Explosion Time (45s to 80s)
            const duration = Math.random() * 35000 + 45000;
            explosionTime = Date.now() + duration;
            sentFast = false;
            sentCritical = false;

            broadcast({
                type: 'NEW_TURN',
                syllable: gameState.syllable,
                playerId: gameState.currentPlayerId
            });

            // Start Bomb Timer
            if (bombInterval) clearInterval(bombInterval);
            bombInterval = setInterval(() => {
                const left = explosionTime - Date.now();
                if (left <= 0) {
                    clearInterval(bombInterval);
                    explodeBomb();
                } else if (left < 10000 && !sentCritical) {
                    sentCritical = true;
                    broadcast({ type: 'BOMB_UPDATE', status: 'CRITICAL' });
                } else if (left < 18000 && !sentFast) {
                    sentFast = true;
                    broadcast({ type: 'BOMB_UPDATE', status: 'FAST' });
                }
            }, 250);
        }

        function passBomb() {
            // Find next living player
            let idx = players.findIndex(p => p.id === gameState.currentPlayerId);
            let loops = 0;
            do {
                idx = (idx + 1) % players.length;
                loops++;
            } while (players[idx].lives <= 0 && loops < players.length);

            gameState.currentPlayerId = players[idx].id;

            broadcast({ type: 'PASS_BOMB', newPlayerId: gameState.currentPlayerId });
        }

        function explodeBomb() {
            broadcast({ type: 'EXPLOSION' });
            // Lose life
            let p = players.find(x => x.id === gameState.currentPlayerId);
            if (p) p.lives--;

            broadcast({ type: 'UPDATE_PLAYERS', list: players });

            // Check Game Over
            const alive = players.filter(p => p.lives > 0);
            if (alive.length <= 1) {
                const duration = Date.now() - gameState.gameStartTime;
                broadcast({
                    type: 'GAME_OVER',
                    winner: alive[0] ? alive[0].name : "NADIE",
                    duration: duration,
                    allWords: gameState.sessionWords
                });
            } else {
                setTimeout(nextRound, 3000);
            }
        }

        function verifyWord(word, syl) {
            if (!word) return false;
            word = word.toUpperCase().trim();

            // 1. Must contain syllable
            if (!word.includes(syl)) return false;

            // 2. Must be in Dictionary
            if (DICTIONARY_SET.size > 0) {
                if (!DICTIONARY_SET.has(word)) return false;
            }

            return true;
        }

        function broadcast(msg) {
            Object.values(clientConns).forEach(c => c.send(msg));
            handleClientData(msg);
        }

        // --- CLIENT LOGIC ---
        function handleClientData(data) {
            if (data.type === 'UPDATE_PLAYERS') {
                players = data.list;
                updateLobby();
                updateGameUI();
            }
            else if (data.type === 'NEW_TURN') {
                show('screen-game');
                document.getElementById('syllable-display').innerText = data.syllable;
                document.getElementById('used-words-list').innerHTML = ''; // Clear List
                updateTurn(data.playerId);
                startTicking();
            }
            else if (data.type === 'WORD_ACCEPTED') {
                const div = document.createElement('div');
                div.className = 'used-word-item';
                div.innerText = data.word;
                const list = document.getElementById('used-words-list');
                list.insertBefore(div, list.firstChild);
            }
            else if (data.type === 'BOMB_UPDATE') {
                const b = document.querySelector('.bomb-body');
                b.classList.remove('ticking', 'fast-ticking', 'critical-ticking');

                if (data.status === 'CRITICAL') b.classList.add('critical-ticking');
                else if (data.status === 'FAST') b.classList.add('fast-ticking');
                else b.classList.add('ticking');
            }
            else if (data.type === 'REJECT_WORD') {
                if (data.playerId === myId) {
                    const inp = document.getElementById('word-input');
                    inp.classList.add('input-error');
                    setTimeout(() => inp.classList.remove('input-error'), 400);
                }
            }
            else if (data.type === 'PASS_BOMB') {
                updateTurn(data.newPlayerId);
            }
            else if (data.type === 'EXPLOSION') {
                const b = document.querySelector('.bomb-body');
                b.classList.add('exploding');
                document.body.classList.add('shake-screen');
                document.body.style.background = 'white';

                setTimeout(() => document.body.style.background = '#c0392b', 100);
                setTimeout(() => {
                    document.body.style.background = '#2c3e50';
                    document.body.classList.remove('shake-screen');
                }, 2000);

                document.getElementById('syllable-display').innerText = " BOOM ";
                stopTicking();
            }
            else if (data.type === 'GAME_OVER') {
                show('screen-results');
                document.getElementById('winner-text').innerText = data.winner;

                // Format Duration
                const seconds = Math.floor((data.duration / 1000) % 60);
                const minutes = Math.floor((data.duration / 1000 / 60) % 60);
                document.getElementById('game-duration').innerText =
                    `Duraci贸n: ${minutes}m ${seconds}s`;

                // Populate List
                const list = document.getElementById('final-words-list');
                list.innerHTML = (data.allWords || []).map(w => `<div>${w}</div>`).join('');

                startConfetti();
            }
        }

        function updateTurn(pid) {
            const p = players.find(x => x.id === pid);
            document.getElementById('turn-msg').innerText = "Turno de: " + (p ? p.name : '?');

            const isMe = (pid === myId);
            if (isMe) {
                document.getElementById('input-area').classList.remove('hidden');
                document.getElementById('word-input').value = '';
                document.getElementById('word-input').focus();
            } else {
                document.getElementById('input-area').classList.add('hidden');
            }
            updateGameUI();
        }

        // UI Helpers
        function updateLobby() {
            const list = document.getElementById('lobby-list');
            list.innerHTML = players.map(p => `<div>${p.name}</div>`).join('');
        }

        function updateGameUI() {
            const list = document.getElementById('player-list');
            list.innerHTML = players.map(p => `
                <div class="player-card ${p.lives <= 0 ? 'dead' : ''} ${p.id === gameState.currentPlayerId ? 'active' : ''}">
                    <div>${p.name}</div>
                    <div class="lives">${'わ'.repeat(p.lives)}</div>
                </div>
            `).join('');
        }

        function submitWord() {
            const word = document.getElementById('word-input').value;
            if (isHost) {
                handleHostData(myId, { type: 'SUBMIT_WORD', word: word });
            } else {
                hostConn.send({ type: 'SUBMIT_WORD', word });
            }
        }

        // --- ANIMATIONS ---
        function startTicking() {
            document.getElementById('spark').style.display = 'block';
            document.querySelector('.bomb-body').className = 'bomb-body ticking';
        }
        function stopTicking() {
            document.getElementById('spark').style.display = 'none';
            document.querySelector('.bomb-body').className = 'bomb-body';
        }

        // --- CONFETTI ---
        let confettiActive = false;
        function startConfetti() {
            if (confettiActive) return;
            confettiActive = true;
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            const colors = ['#f1c40f', '#e74c3c', '#3498db', '#9b59b6', '#2ecc71'];

            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    vx: Math.random() * 2 - 1,
                    vy: Math.random() * 3 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 5 + 5
                });
            }

            function loop() {
                if (!confettiActive) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    if (p.y > canvas.height) p.y = -20;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);
                });
                requestAnimationFrame(loop);
            }
            loop();
        }
        // Enter Key Support
        document.getElementById('word-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') submitWord();
        });
    </script>
</body>

</html>